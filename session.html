<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Analysis - Irish Tune Generator</title>
    <link rel="stylesheet" href="shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.3/dist/abcjs-basic-min.js"></script>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>üìä Session Analysis</h1>
            <p>Analyze variations from The Session and compare different settings</p>
            <button class="back-button" onclick="window.location.href='index.html'">‚Üê Back to Index</button>
        </div>

        <div class="section warning">
            <strong>‚ö†Ô∏è Warning:</strong> This section is experimental and untested. Use at your own risk.
        </div>

        <div class="section">
            <div class="input-group">
                <label for="session-url">The Session URL (required):</label>
                <input type="text" id="session-url" placeholder="https://thesession.org/tunes/1234">
                <small style="color: #666;">Enter a Session URL to analyze tune variations</small>
            </div>

            <button onclick="analyzeSession()">Analyze Session</button>
        </div>

        <div id="error-output" class="section error" style="display:none;">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>

        <div id="session-output" style="display:none;">
            <div class="section">
                <h2 id="tune-title"></h2>
                <div id="tune-info"></div>
            </div>

            <div class="section" id="comparison-section" style="display:none;">
                <h3>Variation Analysis</h3>
                <div id="comparison-content"></div>
            </div>

            <div class="section" id="examples-section" style="display:none;">
                <h3>Example Variations</h3>
                <div id="examples-content"></div>
            </div>

            <div class="section" id="techniques-section" style="display:none;">
                <h3>Unique Techniques Used</h3>
                <div id="techniques-content"></div>
            </div>

            <div class="section" id="settings-section" style="display:none;">
                <h3>ABC Settings</h3>
                <div id="settings-content"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { renderAbc } from './shared/playback.js';

        // Show warning on load
        window.addEventListener('DOMContentLoaded', () => {
            const hasSeenWarning = sessionStorage.getItem('session-warning-seen');
            if (!hasSeenWarning) {
                alert('‚ö†Ô∏è WARNING: This section is experimental and untested.\n\nUse at your own risk. Features may be incomplete or contain bugs.');
                sessionStorage.setItem('session-warning-seen', 'true');
            }
        });

        async function analyzeSession() {
            console.log('[SESSION] Analyzing...');

            const url = document.getElementById('session-url').value.trim();

            if (!url) {
                showError('Please provide a Session URL');
                return;
            }

            hideError();
            document.getElementById('session-output').style.display = 'none';

            // Show loading message (not in error section)
            document.getElementById('session-output').style.display = 'block';
            document.getElementById('session-output').innerHTML = '<p>‚è≥ Analyzing session...</p>';

            try {
                const response = await fetch('/analyze-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[SESSION] Response:', data);

                if (data.error) {
                    showError(data.message + ': ' + data.error);
                    return;
                }

                // Display tune info
                document.getElementById('tune-title').textContent = data.title;
                document.getElementById('tune-info').innerHTML = `
                    <p><strong>Type:</strong> ${data.type} | <strong>Key:</strong> ${data.key}</p>
                    <p><strong>Settings found:</strong> ${data.num_settings}</p>
                `;

                // Display comparison if available
                if (data.comparison) {
                    const comp = data.comparison;

                    if (comp.message) {
                        document.getElementById('comparison-content').innerHTML = `<p><em>${comp.message}</em></p>`;
                    } else {
                        document.getElementById('comparison-content').innerHTML = `
                            <ul>
                                <li><strong>Bars analyzed:</strong> ${comp.num_bars_analyzed}</li>
                                <li><strong>Bars that vary:</strong> ${comp.differences ? comp.differences.length : 0}</li>
                                <li><strong>Stability score:</strong> ${(comp.stability_score * 100).toFixed(1)}%</li>
                            </ul>
                        `;

                        // Show example changes if available
                        if (comp.example_changes && comp.example_changes.length > 0) {
                            let examplesHtml = '';
                            comp.example_changes.forEach((ex, barIdx) => {
                                examplesHtml += `<div style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-left: 3px solid #666;">`;
                                examplesHtml += `<strong>Bar ${ex.bar_number}:</strong><br>`;
                                ex.examples.forEach((bar, idx) => {
                                    // Create a unique ID for each notation rendering
                                    const notationId = `notation-bar${barIdx}-version${idx}`;
                                    examplesHtml += `<div style="margin: 10px 0;">`;
                                    examplesHtml += `<strong style="font-size: 0.9em;">Version ${idx + 1}:</strong>`;
                                    examplesHtml += `<div id="${notationId}" class="notation" style="background: ${idx === 0 ? 'white' : '#fffacd'}; padding: 5px;"></div>`;
                                    examplesHtml += `</div>`;
                                });
                                examplesHtml += `</div>`;
                            });
                            document.getElementById('examples-content').innerHTML = examplesHtml;
                            document.getElementById('examples-section').style.display = 'block';

                            // Render each notation snippet
                            // Get headers from first setting
                            const firstSetting = data.settings[0];
                            const lines = firstSetting.split('\n');
                            const headerEnd = lines.findIndex(l => l.startsWith('K:'));
                            const headers = lines.slice(0, headerEnd + 1).join('\n');

                            comp.example_changes.forEach((ex, barIdx) => {
                                ex.examples.forEach((bar, idx) => {
                                    const notationId = `notation-bar${barIdx}-version${idx}`;
                                    const snippetABC = headers + '\n|' + bar + '|';
                                    renderAbc(notationId, snippetABC);
                                });
                            });
                        }

                        // Show unique techniques
                        if (comp.unique_approaches && comp.unique_approaches.length > 0) {
                            let techHtml = '<ul>';
                            comp.unique_approaches.forEach(approach => {
                                techHtml += `<li><strong>${approach.technique}</strong>: ${approach.description} (Settings: ${approach.settings.join(', ')})</li>`;
                            });
                            techHtml += '</ul>';
                            document.getElementById('techniques-content').innerHTML = techHtml;
                            document.getElementById('techniques-section').style.display = 'block';
                        }
                    }

                    document.getElementById('comparison-section').style.display = 'block';
                }

                // Show settings
                if (data.settings && data.settings.length > 0) {
                    let settingsHtml = '';
                    data.settings.slice(0, 3).forEach((setting, i) => {
                        settingsHtml += `
                            <details>
                                <summary>Setting ${i + 1}</summary>
                                <pre style="background: #f5f5f5; padding: 10px; overflow-x: auto;">${setting}</pre>
                            </details>
                        `;
                    });
                    if (data.settings.length > 3) {
                        settingsHtml += `<p><em>...and ${data.settings.length - 3} more settings</em></p>`;
                    }
                    document.getElementById('settings-content').innerHTML = settingsHtml;
                    document.getElementById('settings-section').style.display = 'block';
                }

                document.getElementById('session-output').style.display = 'block';

            } catch (error) {
                console.error('[SESSION ERROR]', error);
                showError(error.message);
            }
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-output').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-output').style.display = 'none';
        }
    </script>
</body>
</html>
