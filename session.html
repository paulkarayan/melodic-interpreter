<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Analysis - Irish Tune Generator</title>
    <link rel="stylesheet" href="shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.3/dist/abcjs-basic-min.js"></script>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>üìä Session Analysis</h1>
            <p>Analyze how musicians vary tunes on The Session, with AI-powered narrative analysis</p>
            <button class="back-button" onclick="window.location.href='index.html'">‚Üê Back to Index</button>
        </div>

        <div class="section">
            <div class="input-group">
                <label for="session-url">The Session URL:</label>
                <input type="text" id="session-url" placeholder="https://thesession.org/tunes/123" value="https://thesession.org/tunes/335">
                <small style="color: #666;">Enter a tune URL from thesession.org to analyze variations</small>
            </div>

            <div class="input-group">
                <label for="abc-input">Your Key/ABC (optional):</label>
                <textarea id="abc-input" placeholder="K:Ador&#10;or paste your full ABC...">K:Ador</textarea>
                <small style="color: #666;">Provide just the key (e.g., K:Ador) or your full ABC to transpose examples to match</small>
            </div>

            <button onclick="analyzeVariations()">Analyze Variations</button>
        </div>

        <div class="playback-controls">
            <div class="tempo-control">
                <label for="tempo-slider">Tempo (BPM):</label>
                <input type="range" id="tempo-slider" min="60" max="240" value="120" step="5">
                <input type="number" id="tempo-value" min="60" max="240" value="120" step="5">
            </div>
            <button class="stop-button" onclick="stopPlayback()">‚èπ Stop All</button>
        </div>

        <div id="error-output" class="section error" style="display:none;">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>

        <div id="output-section" style="display:none;">
            <div class="section">
                <h2 id="tune-title"></h2>
                <p id="tune-metadata"></p>
            </div>

            <div id="narrative-container" class="section">
                <h3>Variation Analysis</h3>
                <div id="narrative-content" style="white-space: pre-wrap; line-height: 1.8; font-size: 1.05em;"></div>
            </div>

            <div id="examples-container"></div>
        </div>
    </div>

    <script type="module">
        import { playVariation, stopAllPlayback, renderAbc } from './shared/playback.js';

        // State
        let variationAbcs = {};

        // Sync tempo controls
        const tempoSlider = document.getElementById('tempo-slider');
        const tempoValue = document.getElementById('tempo-value');

        tempoSlider.addEventListener('input', () => {
            tempoValue.value = tempoSlider.value;
        });

        tempoValue.addEventListener('input', () => {
            tempoSlider.value = tempoValue.value;
        });


        // Analyze variations
        window.analyzeVariations = async function() {
            console.log('[LLM] Analyzing variations...');

            const url = document.getElementById('session-url').value.trim();

            if (!url) {
                showError('Please provide a Session URL');
                return;
            }

            if (!url.includes('thesession.org')) {
                showError('Please provide a valid thesession.org URL');
                return;
            }

            hideError();
            document.getElementById('output-section').style.display = 'none';

            // Show spinner
            document.getElementById('narrative-content').textContent = '‚è≥ Fetching variations and analyzing... (this may take 1-2 minutes)';
            document.getElementById('output-section').style.display = 'block';

            try {
                const abc = document.getElementById('abc-input').value.trim();

                const response = await fetch('/analyze-session-variations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        user_abc: abc || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[LLM] Response:', data);

                if (data.error) {
                    const errorMsg = data.message + ': ' + data.error;
                    alert('‚ùå Error: ' + errorMsg);
                    showError(errorMsg);
                    document.getElementById('output-section').style.display = 'none';
                    return;
                }

                // Display tune metadata with Session link
                const sessionUrl = document.getElementById('session-url').value.trim();
                document.getElementById('tune-title').innerHTML = `
                    ${data.title}
                    <a href="${sessionUrl}" target="_blank" style="font-size: 0.6em; margin-left: 10px;">üîó View on The Session</a>
                `;
                document.getElementById('tune-metadata').textContent =
                    `${data.type} in ${data.key} | ${data.num_analyzed || data.num_settings} out of ${data.num_settings} settings analyzed`;

                // Display narrative
                document.getElementById('narrative-content').textContent = data.narrative;

                // Clear previous examples
                variationAbcs = {};
                document.getElementById('examples-container').innerHTML = '';

                // Render examples with play buttons and full scores
                if (data.examples && data.examples.length > 0) {
                    let html = '<div class="section"><h3>Musical Examples</h3></div>';

                    data.examples.forEach((example, i) => {
                        // Ensure ABC has proper newlines (unescape if needed)
                        const abc = example.abc.replace(/\\n/g, '\n');
                        variationAbcs[`example-${i}`] = abc;

                        // Build Session setting reference if setting_number is provided
                        const settingRef = example.setting_number
                            ? ` (from Setting ${example.setting_number})`
                            : '';

                        html += `
                            <div class="section variation">
                                <h4>${example.title}${settingRef}</h4>
                                <p class="description">${example.description}</p>
                                <div id="example-${i}" class="notation"></div>
                                <button class="play-button" onclick="playExample(${i})">‚ñ∂ Play</button>
                                <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                            </div>
                        `;
                    });

                    document.getElementById('examples-container').innerHTML = html;

                    // Render all examples (full scores, not snippets)
                    data.examples.forEach((example, i) => {
                        // Ensure ABC has proper newlines (unescape if needed)
                        const abc = example.abc.replace(/\\n/g, '\n');
                        renderAbc(`example-${i}`, abc);
                    });
                }

            } catch (error) {
                console.error('[LLM ERROR]', error);
                showError(error.message);
                document.getElementById('output-section').style.display = 'none';
            }
        };

        // Playback functions
        window.playExample = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`example-${index}`, variationAbcs, tempo);
        };

        window.stopPlayback = function() {
            stopAllPlayback();
        };

        // Error handling
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-output').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-output').style.display = 'none';
        }
    </script>
</body>
</html>
