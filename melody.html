<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melodic Variations - Irish Tune Generator</title>
    <link rel="stylesheet" href="shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.3/dist/abcjs-basic-min.js"></script>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>üéº Melodic Variations</h1>
            <p>Apply melodic variations using traditional and contemporary techniques</p>
            <button class="back-button" onclick="window.location.href='index.html'">‚Üê Back to Index</button>
        </div>

        <div class="section">
            <div class="input-group">
                <label for="abc-input">ABC Notation:</label>
                <textarea id="abc-input" placeholder="Paste ABC notation here...">X:1
T:Sliabh Russell
R:jig
M:6/8
L:1/8
K:Ador
|:eAA Bcd|eaf ged|edB cBA|BAG ABd|
eAA Bcd|eaf ged|edB cBA|1 BAG A3:|2 BAG ABd||
|:eaa efg|agf gfd|eaa efg|afd e3|
eaa efg|agf gfd|edB cBA|BAG ABd:|</textarea>
            </div>

            <div class="input-group">
                <label for="melodic-select">Melodic Variation Type:</label>
                <select id="melodic-select">
                    <optgroup label="Traditional">
                        <option value="neighbor">Neighbor tone substitution</option>
                        <option value="phrase_ending">Phrase ending variation</option>
                        <option value="note_consolidation">Note consolidation (longer durations)</option>
                    </optgroup>
                    <optgroup label="Extended Traditional">
                        <option value="arpeggiation">Arpeggiation (chord tones)</option>
                        <option value="motivic_sequence">Motivic sequence (repeat at different pitch)</option>
                        <option value="contour_simplification">Contour simplification (smooth zigzags)</option>
                        <option value="octave_displacement">Octave displacement</option>
                    </optgroup>
                    <optgroup label="Contemporary">
                        <option value="chromatic">Chromatic passing tones</option>
                        <option value="intervallic_expansion">Intervallic expansion (widen intervals)</option>
                        <option value="rhythmic_consolidation">Rhythmic consolidation (fewer, longer notes)</option>
                        <option value="cross_rhythm">Cross-rhythm (3-against-2)</option>
                    </optgroup>
                    <optgroup label="Experimental">
                        <option value="rhythmic_shift">Rhythmic displacement</option>
                        <option value="simplification">Simplification (reduce to essentials)</option>
                    </optgroup>
                </select>
            </div>

            <div class="input-group">
                <label for="lick-input">Target Specific Lick (optional):</label>
                <input type="text" id="lick-input" placeholder="e.g., eAABcd (leave empty for 2-5 random locations)">
                <small style="color: #666;">If specified, only this pattern will be varied. Otherwise, variations will be applied to 2-5 different spots automatically.</small>
            </div>

            <button onclick="generateVariation()">Generate Variation</button>
            <button onclick="feelingLucky()" style="background-color: #ff9800;">üçÄ Feeling Lucky (5 Random)</button>
        </div>

        <div class="playback-controls">
            <div class="tempo-control">
                <label for="tempo-slider">Tempo (BPM):</label>
                <input type="range" id="tempo-slider" min="60" max="240" value="120" step="5">
                <input type="number" id="tempo-value" min="60" max="240" value="120" step="5">
            </div>
            <button class="stop-button" onclick="stopPlayback()">‚èπ Stop All</button>
        </div>

        <div id="error-output" class="section error" style="display:none;">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>

        <div id="output-section" style="display:none;">
            <div class="section">
                <h2>Original</h2>
                <div id="original-notation" class="notation"></div>
                <div style="margin-top: 10px;">
                    <button class="play-button" onclick="playOriginal()">‚ñ∂ Play Original</button>
                    <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                </div>
            </div>

            <div id="variation-output" class="section variation">
                <h2>Melodic Variation</h2>
                <div id="variation-desc" class="description"></div>
                <div id="variations-container"></div>
            </div>
        </div>

        <div id="lucky-output" style="display:none;">
            <h2>üçÄ Feeling Lucky - 5 Random Melodic Variations</h2>
            <div id="lucky-variations"></div>
        </div>
    </div>

    <script type="module">
        import { playVariation, stopAllPlayback, renderAbc } from './shared/playback.js';
        import { generateMelodicVariation } from './shared/api.js';

        // State
        let variationAbcs = {};

        // Sync tempo controls
        const tempoSlider = document.getElementById('tempo-slider');
        const tempoValue = document.getElementById('tempo-value');

        tempoSlider.addEventListener('input', () => {
            tempoValue.value = tempoSlider.value;
        });

        tempoValue.addEventListener('input', () => {
            tempoSlider.value = tempoValue.value;
        });

        // Generate variation
        window.generateVariation = async function() {
            console.log('[MELODY] Generating variation...');

            const abc = document.getElementById('abc-input').value;
            const melodicType = document.getElementById('melodic-select').value;
            const lick = document.getElementById('lick-input').value.trim() || null;

            if (!abc) {
                showError('Please provide ABC notation');
                return;
            }

            hideError();
            document.getElementById('output-section').style.display = 'none';
            document.getElementById('lucky-output').style.display = 'none';

            // Show spinner
            document.getElementById('variation-desc').textContent = '‚è≥ Generating variation...';
            document.getElementById('variation-output').style.display = 'block';
            document.getElementById('output-section').style.display = 'block';
            document.getElementById('variations-container').innerHTML = '';

            try {
                const data = await generateMelodicVariation(abc, melodicType, lick);

                console.log('[MELODY] Response:', data);

                // Store ABCs
                variationAbcs = {
                    original: data.original,
                    melodic: data.melodic
                };

                console.log('[MELODY] Stored ABCs:', Object.keys(variationAbcs));

                // Render original
                renderAbc('original-notation', data.original);

                // Extract headers from original
                const lines = data.original.split('\n');
                const headerEnd = lines.findIndex(l => l.startsWith('K:'));
                const headers = lines.slice(0, headerEnd + 1).join('\n');

                // Display variation description
                document.getElementById('variation-desc').textContent = data.melodic_desc;

                // Render each changed bar as a separate snippet
                if (data.melodic_changed_bars && data.melodic_changed_bars.length > 0) {
                    console.log('[MELODY] Rendering changed bars as separate snippets');

                    // Group bars by their modified content (same modification = one variation)
                    const groupedBars = {};
                    data.melodic_changed_bars.forEach(bar => {
                        const key = bar.modified;
                        if (!groupedBars[key]) {
                            groupedBars[key] = {
                                modified: bar.modified,
                                original: bar.original,
                                bars: []
                            };
                        }
                        groupedBars[key].bars.push(bar.bar_number);
                    });

                    let html = '';
                    let variationIndex = 0;

                    Object.values(groupedBars).forEach(group => {
                        // Store ABC for this snippet
                        const snippetABC = headers + '\n|' + group.modified + '|';
                        variationAbcs[`snippet-${variationIndex}`] = snippetABC;

                        // Build bar list description
                        const barList = group.bars.length === 1
                            ? `Bar ${group.bars[0]}`
                            : `Bars ${group.bars.join(', ')}`;

                        html += `
                            <div class="section variation" style="margin-top: 20px;">
                                <h4>Variation ${variationIndex + 1}</h4>
                                <p class="description">${barList}: ${group.original} ‚Üí ${group.modified}</p>
                                <div id="snippet-${variationIndex}" class="notation"></div>
                                <div id="full-tune-${variationIndex}" class="notation" style="margin-top: 15px;"></div>
                                <div style="margin-top: 10px;">
                                    <button class="play-button" onclick="playSnippet(${variationIndex})">‚ñ∂ Play Snippet</button>
                                    <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                                    <button class="play-button" onclick="playFullTune(${variationIndex})">‚ñ∂ Play in Full Tune</button>
                                </div>
                            </div>
                        `;
                        variationIndex++;
                    });

                    document.getElementById('variations-container').innerHTML = html;

                    // Render all snippets and full tunes
                    variationIndex = 0;
                    Object.values(groupedBars).forEach(group => {
                        // Render snippet
                        const snippetABC = headers + '\n|' + group.modified + '|';
                        variationAbcs[`snippet-${variationIndex}`] = snippetABC;
                        renderAbc(`snippet-${variationIndex}`, snippetABC);

                        // Create full tune with variation substituted and highlighted
                        const fullTuneABC = createFullTuneWithVariation(data.original, data.melodic_changed_bars, group.bars);
                        variationAbcs[`full-tune-${variationIndex}`] = fullTuneABC;

                        // Render with yellow highlighting for varied bars
                        renderAbcWithHighlight(`full-tune-${variationIndex}`, fullTuneABC, group.bars);

                        variationIndex++;
                    });
                } else {
                    // Fallback: render full variation
                    variationAbcs['full-variation'] = data.melodic;
                    document.getElementById('variations-container').innerHTML = `
                        <div id="full-variation" class="notation"></div>
                        <div style="margin-top: 10px;">
                            <button class="play-button" onclick="playFullVariation()">‚ñ∂ Play</button>
                            <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                        </div>
                    `;
                    renderAbc('full-variation', data.melodic);
                }

                document.getElementById('variation-output').style.display = 'block';
                document.getElementById('output-section').style.display = 'block';

            } catch (error) {
                console.error('[MELODY ERROR]', error);
                showError(error.message);
            }
        };

        // Feeling Lucky
        window.feelingLucky = async function() {
            console.log('[MELODY] Feeling lucky...');

            const abc = document.getElementById('abc-input').value;

            if (!abc) {
                showError('Please provide ABC notation');
                return;
            }

            hideError();
            document.getElementById('output-section').style.display = 'none';
            document.getElementById('lucky-output').style.display = 'block';
            document.getElementById('lucky-variations').innerHTML = '<p>Generating 5 random variations...</p>';

            try {
                // Generate melodic "feeling lucky" by calling /generate with feeling_lucky
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        abc: abc,
                        harmony_type: 'none',
                        melodic_type: 'feeling_lucky',
                        lick: null,
                        validate_anglo: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[MELODY LUCKY] Response:', data);

                // Store original
                variationAbcs.original = data.original;

                // Render variations
                let html = '';
                data.melodic_lucky.forEach((v, i) => {
                    variationAbcs[`melodic-lucky-${i}`] = v.abc;

                    html += `
                        <div class="section variation">
                            <h3>Variation ${i + 1}</h3>
                            <p class="description">${v.description}</p>
                            <div id="lucky-${i}" class="notation"></div>
                            <div style="margin-top: 10px;">
                                <button class="play-button" onclick="playLucky(${i})">‚ñ∂ Play</button>
                                <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('lucky-variations').innerHTML = html;

                // Render all
                data.melodic_lucky.forEach((v, i) => {
                    if (v.changed_bars && v.changed_bars.length > 0) {
                        const lines = data.original.split('\n');
                        const headerEnd = lines.findIndex(l => l.startsWith('K:'));
                        const headers = lines.slice(0, headerEnd + 1).join('\n');
                        let changedBarsABC = headers + '\n';
                        v.changed_bars.forEach(bar => {
                            changedBarsABC += '|' + bar.modified + '|';
                        });
                        renderAbc(`lucky-${i}`, changedBarsABC);
                    } else {
                        renderAbc(`lucky-${i}`, v.abc);
                    }
                });

            } catch (error) {
                console.error('[MELODY LUCKY ERROR]', error);
                showError(error.message);
            }
        };

        // Playback functions
        window.playOriginal = function() {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation('original', variationAbcs, tempo);
        };

        window.playSnippet = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`snippet-${index}`, variationAbcs, tempo);
        };

        window.playFullVariation = function() {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation('full-variation', variationAbcs, tempo);
        };

        window.playLucky = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`melodic-lucky-${index}`, variationAbcs, tempo);
        };

        window.playFullTune = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`full-tune-${index}`, variationAbcs, tempo);
        };

        window.stopPlayback = function() {
            stopAllPlayback();
        };

        // Helper: Create full tune with variation substituted and annotation markers
        function createFullTuneWithVariation(originalABC, changedBars, targetBarNumbers) {
            // Get the melodic content (after headers)
            const lines = originalABC.split('\n');
            const headerEnd = lines.findIndex(l => l.startsWith('K:'));
            const headers = lines.slice(0, headerEnd + 1).join('\n');
            const bodyLines = lines.slice(headerEnd + 1);
            const body = bodyLines.join('\n').replace(/\s+/g, ' ').trim();

            // Create a map of bar number to modified content
            const modifications = {};
            changedBars.forEach(cb => {
                if (targetBarNumbers.includes(cb.bar_number)) {
                    modifications[cb.bar_number] = cb.modified;
                }
            });

            console.log('[MELODY] Original body:', body);
            console.log('[MELODY] Target bar numbers:', targetBarNumbers);
            console.log('[MELODY] Modifications:', modifications);

            // Split by | but need to handle repeat markers like |: and :| correctly
            // These are NOT bar separators, they're repeat markers
            const parts = body.split('|');

            let result = headers + '\n';
            let currentBarNum = 0;

            for (let i = 0; i < parts.length; i++) {
                let part = parts[i].trim();

                // Handle bar separator
                if (i > 0) {
                    result += '|';
                }

                // Skip truly empty parts
                if (!part) {
                    continue;
                }

                // Check if this part is a repeat marker (: at start or end)
                const startsWithRepeat = part.startsWith(':');
                const endsWithRepeat = part.endsWith(':');

                if (startsWithRepeat) {
                    result += ':';
                    part = part.substring(1).trim();
                }

                // If there's actual music content (not just a repeat marker)
                if (part && part !== ':') {
                    currentBarNum++;

                    // Check if this bar should be modified
                    const barContent = modifications[currentBarNum] || part;

                    // Add annotation BEFORE the bar content if it's modified
                    if (modifications[currentBarNum]) {
                        result += `"_Varied"${barContent}`;
                        console.log(`[MELODY] Added "Varied" annotation to bar ${currentBarNum}: ${barContent}`);
                    } else {
                        result += barContent;
                    }
                }

                if (endsWithRepeat && !startsWithRepeat) {
                    result += ':';
                }
            }

            console.log('[MELODY] Final ABC (first 400 chars):', result.substring(0, 400));
            return result;
        }

        // Helper: Render ABC with highlighted bars
        function renderAbcWithHighlight(elementId, abc, highlightedBarNumbers) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.error('[MELODY] Element not found:', elementId);
                return;
            }

            console.log('[MELODY] Highlighting bars:', highlightedBarNumbers, 'in', elementId);

            // Render the ABC
            const visualObjs = ABCJS.renderAbc(elementId, abc, {
                responsive: 'resize'
            });

            // Wait for render, then find and highlight the "Varied" annotations
            setTimeout(() => {
                if (!visualObjs || visualObjs.length === 0) return;

                const svg = element.querySelector('svg');
                if (!svg) return;

                // Find all text elements with "Varied" annotation
                const textElements = svg.querySelectorAll('text');
                const variedAnnotations = [];

                textElements.forEach(textEl => {
                    if (textEl.textContent.includes('Varied')) {
                        variedAnnotations.push(textEl);
                        // Hide the annotation text
                        textEl.style.display = 'none';
                    }
                });

                console.log(`[MELODY] Found ${variedAnnotations.length} "Varied" annotations`);

                // For each annotation, find the bar that follows it and highlight it
                variedAnnotations.forEach(annotation => {
                    const annotationX = parseFloat(annotation.getAttribute('x'));
                    const annotationY = parseFloat(annotation.getAttribute('y'));

                    console.log(`[MELODY] Annotation at x=${annotationX}, y=${annotationY}`);

                    // Collect all note elements to the right of this annotation until the next bar line
                    let minX = null, maxX = null, minY = null, maxY = null;

                    const allElements = svg.querySelectorAll('path, rect, text');
                    allElements.forEach(el => {
                        try {
                            const bbox = el.getBBox();
                            const elX = bbox.x;
                            const elY = bbox.y;

                            // Check if this element is near the annotation vertically and to its right
                            // Look for elements within the same staff (similar Y) and after the annotation
                            if (Math.abs(elY - annotationY) < 50 && elX >= annotationX && elX < annotationX + 150) {
                                if (minX === null || bbox.x < minX) minX = bbox.x;
                                if (maxX === null || bbox.x + bbox.width > maxX) maxX = bbox.x + bbox.width;
                                if (minY === null || bbox.y < minY) minY = bbox.y;
                                if (maxY === null || bbox.y + bbox.height > maxY) maxY = bbox.y + bbox.height;
                            }
                        } catch (e) {}
                    });

                    if (minX !== null) {
                        console.log(`[MELODY] Highlighting region: x=${minX}, y=${minY}, w=${maxX-minX}, h=${maxY-minY}`);
                        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                        rect.setAttribute('x', minX - 3);
                        rect.setAttribute('y', minY - 3);
                        rect.setAttribute('width', maxX - minX + 6);
                        rect.setAttribute('height', maxY - minY + 6);
                        rect.setAttribute('fill', '#ffeb3b');
                        rect.setAttribute('opacity', '0.5');
                        rect.setAttribute('rx', '3');
                        svg.insertBefore(rect, svg.firstChild);
                    }
                });
            }, 200);
        };

        // Error handling
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-output').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-output').style.display = 'none';
        }
    </script>
</body>
</html>
