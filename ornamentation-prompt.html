<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Ornamentation Transformations - Irish Tune Generator</title>
    <link rel="stylesheet" href="shared/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.4.3/dist/abcjs-basic-min.js"></script>
</head>
<body>
    <div class="container">
        <div class="section">
            <h1>‚ú® AI Ornamentation Transformations</h1>
            <p>Add ornamentation using AI-powered techniques from Irish traditional music</p>
            <button class="back-button" onclick="window.location.href='index.html'">‚Üê Back to Index</button>
        </div>

        <div class="section">
            <div class="input-group">
                <label for="abc-input">ABC Notation:</label>
                <textarea id="abc-input" placeholder="Paste ABC notation here...">X:1
T:Sliabh Russell
R:jig
M:6/8
L:1/8
K:Ador
|:eAA Bcd|eaf ged|edB cBA|BAG ABd|
eAA Bcd|eaf ged|edB cBA|1 BAG A3:|2 BAG ABd||
|:eaa efg|agf gfd|eaa efg|afd e3|
eaa efg|agf gfd|edB cBA|BAG ABd:|</textarea>
            </div>

            <div class="input-group">
                <label for="ornamentation-select">Ornamentation Type:</label>
                <select id="ornamentation-select">
                    <optgroup label="Basic Ornament Types">
                        <option value="cuts_on_downbeats">Cuts On Downbeats</option>
                        <option value="taps_for_grounding">Taps For Grounding</option>
                        <option value="long_rolls_jig_placement">Long Rolls Jig Placement</option>
                        <option value="short_rolls_reel_placement">Short Rolls Reel Placement</option>
                        <option value="triplets_characteristic">Triplets Characteristic</option>
                        <option value="slides_melodic">Slides Melodic</option>
                        <option value="crans_low_notes">Crans Low Notes</option>
                        <option value="bounces_casadh">Bounces Casadh</option>
                    </optgroup>
                    <optgroup label="Instrument-Specific Ornaments">
                        <option value="fiddle_bowed_triplets">Fiddle Bowed Triplets</option>
                        <option value="concertina_phantom_button">Concertina Phantom Button</option>
                        <option value="concertina_bellows_shake">Concertina Bellows Shake</option>
                        <option value="accordion_bellows_pulse">Accordion Bellows Pulse</option>
                        <option value="whistle_flute_tonguing">Whistle Flute Tonguing</option>
                        <option value="whistle_breath_ornaments">Whistle Breath Ornaments</option>
                        <option value="pipes_regulator_style">Pipes Regulator Style</option>
                    </optgroup>
                    <optgroup label="Rhythmic Placement Strategies">
                        <option value="ornament_strong_beats_only">Ornament Strong Beats Only</option>
                        <option value="ornament_phrase_beginnings">Ornament Phrase Beginnings</option>
                        <option value="ornament_cadence_points">Ornament Cadence Points</option>
                        <option value="ornament_long_notes_only">Ornament Long Notes Only</option>
                        <option value="alternating_ornament_pattern">Alternating Ornament Pattern</option>
                    </optgroup>
                    <optgroup label="Density and Intensity Levels">
                        <option value="minimal_sparse_ornaments">Minimal Sparse Ornaments</option>
                        <option value="moderate_tasteful_ornaments">Moderate Tasteful Ornaments</option>
                        <option value="dense_elaborate_ornaments">Dense Elaborate Ornaments</option>
                        <option value="progressive_density_build">Progressive Density Build</option>
                    </optgroup>
                    <optgroup label="Regional Style Approaches">
                        <option value="sligo_style_ornaments">Sligo Style Ornaments</option>
                        <option value="east_clare_galway_minimal">East Clare Galway Minimal</option>
                        <option value="donegal_aggressive_ornaments">Donegal Aggressive Ornaments</option>
                        <option value="west_clare_rich_ornaments">West Clare Rich Ornaments</option>
                        <option value="sliabh_luachra_rhythmic">Sliabh Luachra Rhythmic</option>
                        <option value="jig_ornament_patterns">Jig Ornament Patterns</option>
                        <option value="reel_ornament_patterns">Reel Ornament Patterns</option>
                        <option value="slow_air_ornaments">Slow Air Ornaments</option>
                        <option value="hornpipe_dotted_ornaments">Hornpipe Dotted Ornaments</option>
                        <option value="polka_driving_ornaments">Polka Driving Ornaments</option>
                        <option value="slip_jig_graceful_ornaments">Slip Jig Graceful Ornaments</option>
                    </optgroup>
                    <optgroup label="Variation Approaches">
                        <option value="ornament_type_substitution">Ornament Type Substitution</option>
                        <option value="ornament_removal_simplification">Ornament Removal Simplification</option>
                        <option value="ornament_displacement">Ornament Displacement</option>
                        <option value="call_response_ornamentation">Call Response Ornamentation</option>
                    </optgroup>
                    <optgroup label="Advanced Techniques">
                        <option value="spontaneous_varied_ornaments">Spontaneous Varied Ornaments</option>
                        <option value="cross_row_ornaments_concertina">Cross Row Ornaments Concertina</option>
                        <option value="double_stop_ornaments_fiddle">Double Stop Ornaments Fiddle</option>
                        <option value="harmonic_ornament_combinations">Harmonic Ornament Combinations</option>
                    </optgroup>
                    <optgroup label="Learning Progression Levels">
                        <option value="beginner_essential_ornaments">Beginner Essential Ornaments</option>
                        <option value="intermediate_standard_ornaments">Intermediate Standard Ornaments</option>
                        <option value="advanced_master_ornaments">Advanced Master Ornaments</option>
                    </optgroup>
                    <optgroup label="Special Contexts">
                        <option value="session_appropriate_ornaments">Session Appropriate Ornaments</option>
                        <option value="solo_performance_ornaments">Solo Performance Ornaments</option>
                        <option value="teaching_demonstration_ornaments">Teaching Demonstration Ornaments</option>
                        <option value="accompaniment_light_ornaments">Accompaniment Light Ornaments</option>
                    </optgroup>
                </select>
            </div>

            <button onclick="generateTransformation()">Generate Transformation</button>
            <button onclick="feelingLucky()" style="background-color: #ff9800;">üçÄ Feeling Lucky (5 Random)</button>
        </div>

        <div class="playback-controls">
            <div class="tempo-control">
                <label for="tempo-slider">Tempo (BPM):</label>
                <input type="range" id="tempo-slider" min="60" max="240" value="120" step="5">
                <input type="number" id="tempo-value" min="60" max="240" value="120" step="5">
            </div>
            <button class="stop-button" onclick="stopPlayback()">‚èπ Stop All</button>
        </div>

        <div id="error-output" class="section error" style="display:none;">
            <strong>Error:</strong> <span id="error-message"></span>
        </div>

        <div id="output-section" style="display:none;">
            <div class="section">
                <h2>Original</h2>
                <div id="original-notation" class="notation"></div>
                <div style="margin-top: 10px;">
                    <button class="play-button" onclick="playOriginal()">‚ñ∂ Play Original</button>
                    <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                </div>
            </div>

            <div id="transformation-output" class="section variation">
                <h2>Transformed Melody</h2>
                <div id="transformation-desc" class="description"></div>
                <div id="transformation-explanation" class="description" style="margin-top: 10px; font-style: italic;"></div>
                <div id="transformations-container"></div>
            </div>
        </div>

        <div id="lucky-output" style="display:none;">
            <h2>üçÄ Feeling Lucky - 5 Random Transformations</h2>
            <div id="lucky-variations"></div>
        </div>
    </div>

    <script type="module">
        import { playVariation, stopAllPlayback, renderAbc } from './shared/playback.js';

        // State
        let variationAbcs = {};

        // Sync tempo controls
        const tempoSlider = document.getElementById('tempo-slider');
        const tempoValue = document.getElementById('tempo-value');

        tempoSlider.addEventListener('input', () => {
            tempoValue.value = tempoSlider.value;
        });

        tempoValue.addEventListener('input', () => {
            tempoSlider.value = tempoValue.value;
        });

        // Generate transformation
        window.generateTransformation = async function() {
            console.log('[ORNAMENTATION-PROMPT] Generating transformation...');

            const abc = document.getElementById('abc-input').value;
            const transformationType = document.getElementById('ornamentation-select').value;

            if (!abc) {
                showError('Please provide ABC notation');
                return;
            }

            hideError();
            document.getElementById('output-section').style.display = 'none';
            document.getElementById('lucky-output').style.display = 'none';

            // Show spinner
            document.getElementById('transformation-desc').textContent = '‚è≥ Generating transformation...';
            document.getElementById('transformation-output').style.display = 'block';
            document.getElementById('output-section').style.display = 'block';

            try {
                const response = await fetch('/transform-ornamentation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        abc: abc,
                        transformation: transformationType
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[ORNAMENTATION-PROMPT] Response:', data);

                if (data.error) {
                    const errorMsg = data.message + ': ' + data.error;
                    alert('‚ùå Error: ' + errorMsg);
                    showError(errorMsg);
                    return;
                }

                // Store original ABC
                variationAbcs = {
                    original: data.original
                };

                // Render original
                renderAbc('original-notation', data.original);

                // Extract headers from original
                const lines = data.original.split('\n');
                const headerEnd = lines.findIndex(l => l.startsWith('K:'));
                const headers = lines.slice(0, headerEnd + 1).join('\n');

                // Display transformation description and explanation
                document.getElementById('transformation-desc').textContent =
                    `${transformationType.replace(/_/g, ' ')}: ${data.description}`;
                document.getElementById('transformation-explanation').textContent =
                    data.explanation || '';

                // Render changed bars as separate snippets (like melody.html)
                if (data.changed_bars && data.changed_bars.length > 0) {
                    // Group bars by their modified content
                    const groupedBars = {};
                    data.changed_bars.forEach(bar => {
                        const key = bar.modified;
                        if (!groupedBars[key]) {
                            groupedBars[key] = {
                                modified: bar.modified,
                                original: bar.original,
                                bars: []
                            };
                        }
                        groupedBars[key].bars.push(bar.bar_number);
                    });

                    let html = '';
                    let variationIndex = 0;

                    Object.values(groupedBars).forEach(group => {
                        const snippetABC = headers + '\n|' + group.modified + '|';
                        variationAbcs[`snippet-${variationIndex}`] = snippetABC;

                        const barList = group.bars.length === 1
                            ? `Bar ${group.bars[0]}`
                            : `Bars ${group.bars.join(', ')}`;

                        html += `
                            <div class="section variation" style="margin-top: 20px;">
                                <h4>Variation ${variationIndex + 1}</h4>
                                <p class="description">${barList}: ${group.original} ‚Üí ${group.modified}</p>
                                <div id="snippet-${variationIndex}" class="notation"></div>
                                <div style="margin-top: 10px;">
                                    <button class="play-button" onclick="playSnippet(${variationIndex})">‚ñ∂ Play</button>
                                    <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                                </div>
                            </div>
                        `;
                        variationIndex++;
                    });

                    document.getElementById('transformations-container').innerHTML = html;

                    // Render all snippets
                    variationIndex = 0;
                    Object.values(groupedBars).forEach(group => {
                        const snippetABC = headers + '\n|' + group.modified + '|';
                        renderAbc(`snippet-${variationIndex}`, snippetABC);
                        variationIndex++;
                    });
                } else {
                    // Fallback: render full transformation
                    variationAbcs['full-transformation'] = data.transformed_abc;
                    document.getElementById('transformations-container').innerHTML = `
                        <div id="full-transformation" class="notation"></div>
                        <div style="margin-top: 10px;">
                            <button class="play-button" onclick="playFullTransformation()">‚ñ∂ Play</button>
                            <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                        </div>
                    `;
                    renderAbc('full-transformation', data.transformed_abc);
                }

                document.getElementById('transformation-output').style.display = 'block';
                document.getElementById('output-section').style.display = 'block';

            } catch (error) {
                console.error('[ORNAMENTATION-PROMPT ERROR]', error);
                showError(error.message);
            }
        };

        // Feeling Lucky
        window.feelingLucky = async function() {
            console.log('[ORNAMENTATION-PROMPT] Feeling lucky...');

            const abc = document.getElementById('abc-input').value;

            if (!abc) {
                showError('Please provide ABC notation');
                return;
            }

            hideError();
            document.getElementById('output-section').style.display = 'none';
            document.getElementById('lucky-output').style.display = 'block';
            document.getElementById('lucky-variations').innerHTML = '<p>Generating 5 random transformations (this may take 1-2 minutes)...</p>';

            try {
                const response = await fetch('/transform-ornamentation-lucky', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        abc: abc
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('[ORNAMENTATION-PROMPT LUCKY] Response:', data);

                if (data.error) {
                    const errorMsg = data.message + ': ' + data.error;
                    alert('‚ùå Error: ' + errorMsg);
                    showError(errorMsg);
                    document.getElementById('lucky-variations').innerHTML = '';
                    return;
                }

                // Store original
                variationAbcs.original = data.original;

                // Render variations
                let html = '';
                data.transformations.forEach((trans, i) => {
                    variationAbcs[`lucky-${i}`] = trans.abc;

                    html += `
                        <div class="section variation">
                            <h3>${trans.name.replace(/_/g, ' ')}</h3>
                            <p class="description">${trans.description}</p>
                            ${trans.explanation ? `<p class="description" style="font-style: italic; margin-top: 10px;">${trans.explanation}</p>` : ''}
                            <div id="lucky-${i}" class="notation"></div>
                            <div style="margin-top: 10px;">
                                <button class="play-button" onclick="playLucky(${i})">‚ñ∂ Play</button>
                                <button class="stop-button" onclick="stopPlayback()">‚èπ Stop</button>
                            </div>
                        </div>
                    `;
                });

                document.getElementById('lucky-variations').innerHTML = html;

                // Render all
                data.transformations.forEach((trans, i) => {
                    renderAbc(`lucky-${i}`, trans.abc);
                });

            } catch (error) {
                console.error('[ORNAMENTATION-PROMPT LUCKY ERROR]', error);
                showError(error.message);
                document.getElementById('lucky-variations').innerHTML = '';
            }
        };

        // Playback functions
        window.playOriginal = function() {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation('original', variationAbcs, tempo);
        };

        window.playSnippet = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`snippet-${index}`, variationAbcs, tempo);
        };

        window.playFullTransformation = function() {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation('full-transformation', variationAbcs, tempo);
        };

        window.playLucky = function(index) {
            const tempo = parseInt(document.getElementById('tempo-value').value);
            playVariation(`lucky-${index}`, variationAbcs, tempo);
        };

        window.stopPlayback = function() {
            stopAllPlayback();
        };

        // Error handling
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-output').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error-output').style.display = 'none';
        }
    </script>
</body>
</html>
